ğŸ¬ FocalPoint AI â€” Performance + Timecode Fidelity Upgrade
Objective

è§£æ±ºå…©å€‹æ ¸å¿ƒå•é¡Œï¼š

æ•´é«”åˆ†ææµç¨‹éæ…¢

å¤š persona åˆ†æé‡è¤‡ ingest åŒä¸€éƒ¨å½±ç‰‡

ä¸Šå‚³ pipeline I/O éå¤š

Grounding pass å¢åŠ  latency

Timecode ä¸æº–ç¢º

æè¿°æ˜¯æ­£ç¢ºçš„ï¼Œä½†æ™‚é–“èˆ‡å¯¦éš›ç•«é¢éŒ¯ä½

é•·ç‰‡ï¼ˆ90+ minï¼‰èª¤å·®åš´é‡

PHASE A â€” Model & Cache Architecture Refactor
Ticket A1 â€” Remove Gemini 3 Pro, Standardize Model Strategy
Goal

çµ±ä¸€ä½¿ç”¨ gemini-3-flash-previewï¼Œfallback è‡³ gemini-2.5-flashã€‚

Scope

ç§»é™¤æ‰€æœ‰ gemini-3-pro* references

å»ºç«‹çµ±ä¸€ model selector function

Implementation

File: server/geminiClient.ts (create if missing)

export async function callGeminiWithFallback(config) {
  try {
    return await callGemini("gemini-3-flash-preview", config);
  } catch (err) {
    if (isRetryable(err)) {
      return await callGemini("gemini-2.5-flash", config);
    }
    throw err;
  }
}

Acceptance Criteria

Production logs ä¸å†å‡ºç¾ pro model

Fallback åƒ…åœ¨ transient failure ç™¼ç”Ÿ

Ticket A2 â€” Global Explicit Context Cache (High ROI Optimization)
Goal

å½±ç‰‡ ACTIVE å¾Œå»ºç«‹ã€Œå…¨åŸŸ Cacheã€ï¼Œæ‰€æœ‰ persona çš„ Pass 1 / Pass 2 å…±ç”¨ã€‚

Database Changes

Migration:

ALTER TABLE uploads
ADD COLUMN cache_name TEXT,
ADD COLUMN cache_model TEXT,
ADD COLUMN cache_status TEXT DEFAULT 'NONE',
ADD COLUMN cache_expires_at TIMESTAMP,
ADD COLUMN cache_last_error TEXT;

Implementation
New Helper

File: server/cacheService.ts

export async function ensureVideoCache(uploadId: string) {
  const upload = await db.getUpload(uploadId);

  if (upload.cache_name && upload.cache_expires_at > new Date()) {
    log("Cache_Hit", uploadId);
    return upload.cache_name;
  }

  log("Cache_Create_Start", uploadId);

  const cache = await gemini.createCache({
    model: "gemini-3-flash-preview",
    fileUri: upload.gemini_file_uri,
    ttlSeconds: 3600
  });

  await db.updateUpload(uploadId, {
    cache_name: cache.name,
    cache_model: "gemini-3-flash-preview",
    cache_status: "ACTIVE",
    cache_expires_at: cache.expiresAt
  });

  log("Cache_Create_Success", uploadId);

  return cache.name;
}

Modify Analysis Flow

File: processAnalysisJob()

Before calling Pass 1:

const cacheName = await ensureVideoCache(uploadId);


Pass to Gemini:

generateContent({
  cachedContent: cacheName,
  ...
})

Expected Outcome
Before	After
æ¯ persona é‡è®€å½±ç‰‡	æ‰€æœ‰ persona å…±ç”¨ cache
4 personas = 4x video cost	1x video cost
åˆ†æ wall time é«˜	wall time é¡¯è‘—ä¸‹é™
PHASE B â€” Upload Pipeline Optimization
Ticket B1 â€” Remove Server Temp File I/O
Current Problem

Object Storage â†’ temp file â†’ Gemini
å¤šä¸€æ¬¡å®Œæ•´ disk I/Oã€‚

New Flow

Object Storage â†’ Range Stream â†’ Gemini Resumable Upload

Implementation

File: transferToGemini()

Remove:

downloadToTempFile()


Replace with:

for (offset = 0; offset < totalSize; offset += chunkSize) {
  const chunk = await objectStorage.getRange(offset, offset + chunkSize);
  await gemini.uploadChunk(resumableUrl, chunk, offset);
}

Acceptance Criteria

ä¸å†ç”Ÿæˆ temp file

server disk I/O é¡¯è‘—ä¸‹é™

upload wall time é™ä½

PHASE C â€” Timecode Fidelity Upgrade
Ticket C1 â€” Extend Schema (Evidence + Confidence)
Add Fields

For each highlight/concern:

{
  "seconds": number,
  "timestamp": "HH:MM:SS",
  "timecode_evidence": "string",
  "timecode_confidence": "high|medium|low"
}

Prompt Update (Pass 1)

Add rule:

After choosing seconds, you MUST provide one sentence of concrete visual or audio evidence visible at that exact time.
If you cannot provide evidence, reduce confidence to "low" and propose a range.

Ticket C2 â€” Grounding Verification Pass
Goal

Second pass ä¸é‡æ–°åˆ†æå½±ç‰‡ï¼Œè€Œæ˜¯ã€Œå®šä½ã€å·²æè¿°äº‹ä»¶ã€‚

Grounding Prompt (Per 10 items, single call)

System:

You are a verification assistant.
Your job is to locate described events in the video and verify timestamps.


User:

For each item below:
- original_seconds
- description

Return:
- original_seconds
- corrected_seconds
- corrected_timestamp
- confidence (high/medium/low)
- evidence
- range_seconds (if low)

Correction Logic
if (confidence !== "low") {
  item.seconds = corrected_seconds;
}

Acceptance Criteria

æ¯ item éƒ½æœ‰ evidence

é•·ç‰‡ time drift é¡¯è‘—é™ä½

è‹¥éŒ¯èª¤ â†’ confidence=low è€Œéå‡ç²¾æº–

PHASE D â€” Polling Optimization
Ticket D1 â€” Adaptive Polling for ACTIVE

Replace fixed 15s polling:

Time	Interval
0â€“60s	5s
60â€“180s	10s
180s+	15â€“30s
Ticket D2 â€” Frontend Job Polling Backoff
Time	Interval
0â€“30s	2s
30â€“120s	5s
120s+	10s
PHASE E â€” Progress Write Safety
Ticket E1 â€” Make Progress Updates Non-Fatal
Requirements

ä¸ await progress DB write

æ¯ 5 ç§’æœ€å¤šå¯«ä¸€æ¬¡

DB error ä¸æ‡‰ä¸­æ­¢ job

throttle(progressUpdate, 5000);

Architecture After Refactor
Browser
   â”‚
   â”œâ”€â”€ Presigned Upload â†’ Object Storage
   â”‚
Server
   â”œâ”€â”€ Stream Range â†’ Gemini
   â”‚
   â”œâ”€â”€ Create Global Cache (once)
   â”‚
   â”œâ”€â”€ Persona 1 (cached)
   â”œâ”€â”€ Persona 2 (cached)
   â”œâ”€â”€ Persona 3 (cached)
   â”œâ”€â”€ Persona 4 (cached)
   â”‚
   â”œâ”€â”€ Grounding Pass (cached)
   â”‚
Frontend Poll â†’ Completed Report

Expected Impact
Area	Improvement
Multi-persona latency	â†“ 50â€“70%
Gemini token cost	â†“ up to 80â€“90%
Timecode accuracy	Significantly improved
Long-film drift	Reduced
Server I/O	Reduced